name: CI

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '.vscode/**'
      - '.idea/**'
  pull_request:
    branches: [ "**" ]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '.vscode/**'
      - '.idea/**'

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Permissions needed for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-test-windows:
    name: Test (windows-latest, py${{ matrix.python-version }})
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12", "3.13", "3.14"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~\AppData\Local\uv\Cache
          key: ${{ runner.os }}-uv-${{ hashFiles('uv.lock') }}
      - name: Install dependencies
        run: |
          uv sync --group dev
      - name: Cache pre-commit
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: ${{ runner.os }}-precommit-${{ hashFiles('.pre-commit-config.yaml') }}
      - name: Pre-commit
        run: |
          uv run pre-commit run --all-files --show-diff-on-failure
      - name: Run tests with coverage
        run: |
          uv run pytest -n auto --junitxml=junit-windows-latest-py${{ matrix.python-version }}.xml
      - name: Upload JUnit test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-windows-latest-py${{ matrix.python-version }}
          path: junit-windows-latest-py${{ matrix.python-version }}.xml
          if-no-files-found: warn
      - name: Upload coverage data file
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-data-windows-latest-py${{ matrix.python-version }}
          path: .coverage
          if-no-files-found: warn

  build-test-unix:
    name: Test (${{ matrix.os }}, py${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    needs: build-test-windows
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.12", "3.13", "3.14"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~\AppData\Local\uv\Cache
          key: ${{ runner.os }}-uv-${{ hashFiles('uv.lock') }}
      - name: Install dependencies
        run: |
          uv sync --group dev
      - name: Cache pre-commit
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: ${{ runner.os }}-precommit-${{ hashFiles('.pre-commit-config.yaml') }}
      - name: Pre-commit
        run: |
          uv run pre-commit run --all-files --show-diff-on-failure
      - name: Run tests with coverage
        run: |
          uv run pytest -n auto --junitxml=junit-${{ matrix.os }}-py${{ matrix.python-version }}.xml
      - name: Upload JUnit test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-${{ matrix.os }}-py${{ matrix.python-version }}
          path: junit-${{ matrix.os }}-py${{ matrix.python-version }}.xml
          if-no-files-found: warn
      - name: Upload coverage data file
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-data-${{ matrix.os }}-py${{ matrix.python-version }}
          path: .coverage
          if-no-files-found: warn

  coverage-aggregate:
    name: Coverage Aggregate
    runs-on: ubuntu-latest
    needs: [build-test-windows, build-test-unix]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.x
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      - name: Download coverage data artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-data-*
          path: coverage-data
          merge-multiple: false
      - name: Install dependencies for coverage tooling
        run: |
          uv sync --group dev
      - name: Prepare coverage files
        shell: bash
        run: |
          bash scripts/ci/prepare_coverage.sh
      - name: Combine and report coverage
        shell: bash
        run: |
          bash scripts/ci/combine_coverage.sh
      - name: Upload combined coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-combined
          path: |
            coverage.xml
            htmlcov
          if-no-files-found: warn

  build-graphs:
    name: Build Graphs
    runs-on: ubuntu-latest
    needs: [coverage-aggregate]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      - name: Install dependencies
        run: |
          uv sync --group dev
      - name: Restore previous pages artifact
        id: download-pages
        uses: actions/download-artifact@v4
        with:
          name: github-pages
          path: artifacts
        continue-on-error: true
      - name: Prepare artifact workspace
        run: |
          mkdir -p artifacts
          if [ -d "artifacts" ]; then
            echo "Artifacts directory ready"
          fi
      - name: Build graphs
        shell: bash
        run: |
          bash scripts/ci/build_graphs.sh artifacts both scripts/pages_index.html
      - name: List generated graphs
        run: |
          find artifacts -maxdepth 2 -type f | sort
      - name: Upload graphs artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: graphs
          path: artifacts/graphs
          if-no-files-found: warn

  deploy-pages:
    name: Deploy GitHub Pages
    needs: build-graphs
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Download graphs artifact
        uses: actions/download-artifact@v4
        with:
          name: graphs
          path: ./site
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./site
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
